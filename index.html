<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>浩瀚星際：互動VR星球探險遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0a0a1a; font-family: 'Segoe UI', sans-serif; user-select: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        .ui-layer { position: absolute; z-index: 10; pointer-events: none; width: 100%; height: 100%; }
        .interactive { pointer-events: auto; }

        .glass-panel {
            background: rgba(20, 30, 50, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(120, 220, 255, 0.4);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* 說明視窗樣式優化 */
        .instruction-box {
            background: rgba(10, 15, 30, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px;
            color: #fff;
            max-width: 320px;
            pointer-events: none; 
            box-shadow: 0 4px 30px rgba(0,0,0,0.8);
            transition: opacity 0.5s ease;
            position: relative;
        }
        .instruction-box button { pointer-events: auto; }

        /* 分頁切換按鈕 */
        .tab-container {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 12px;
            padding-bottom: 8px;
            gap: 15px;
        }
        .tab-btn {
            font-size: 14px;
            font-weight: bold;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.3s;
            display: flex; align-items: center; gap: 6px;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .tab-btn.active { 
            color: #4facfe; 
            background: rgba(79, 172, 254, 0.15);
            border: 1px solid rgba(79, 172, 254, 0.3);
        }
        
        /* [修改] 分數計分板樣式 - 改為相對定位 */
        .score-board {
            /* 移除絕對定位，讓它跟隨文字排列 */
            margin-top: 12px; /* 與上方小標題保持距離 */
            display: inline-flex; /* 寬度隨內容縮放，不要佔滿整行 */
            
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #ffd700;
            border-radius: 50px;
            padding: 6px 20px; /* 稍微調整內距 */
            color: #ffd700;
            font-family: 'Impact', sans-serif;
            font-size: 20px; /* 字體微調適中 */
            letter-spacing: 2px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            align-items: center; 
            gap: 10px;
            pointer-events: auto;
        }

        .key-badge {
            display: inline-flex; align-items: center; justify-content: center;
            background: rgba(79, 172, 254, 0.3);
            border: 1px solid rgba(79, 172, 254, 0.6);
            border-radius: 6px; padding: 4px 8px;
            font-size: 11px; font-weight: bold; color: #e0f0ff;
            min-width: 90px;
            margin-right: 8px;
        }

        .help-btn {
            position: absolute; top: 20px; right: 20px;
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(20, 30, 50, 0.8); border: 1px solid rgba(255, 255, 255, 0.4);
            color: #4facfe; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s;
            z-index: 60; pointer-events: auto;
            opacity: 0; pointer-events: none;
        }
        .help-btn.visible { opacity: 1; pointer-events: auto; }
        .help-btn:hover { background: rgba(79, 172, 254, 0.4); border-color: #fff; }

        .rotate-controls {
            position: absolute; bottom: 140px; right: 20px;
            display: flex; gap: 10px; z-index: 50;
            pointer-events: auto;
        }
        .rotate-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(79, 172, 254, 0.5);
            color: #fff; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .rotate-btn:active { background: rgba(79, 172, 254, 0.4); transform: scale(0.95); }

        .planet-btn {
            width: 60px; height: 60px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            background-size: cover; background-position: center;
            background-repeat: no-repeat;
            transition: all 0.4s; cursor: pointer; flex-shrink: 0; position: relative; 
            background-color: #111; 
            background-blend-mode: screen; 
        }
        .planet-btn.active {
            transform: scale(1.3) translateY(-10px);
            border-color: #4facfe;
            box-shadow: 0 0 35px rgba(79, 172, 254, 1.0);
            z-index: 20;
            background-color: #333;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #loader {
            position: fixed; inset: 0; background: #050510; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
        }
        
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .cursor-rotate { cursor: alias; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="loader">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-4 border-blue-900/30 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
        </div>
        <div class="text-blue-200 text-xs tracking-[0.5em] font-light animate-pulse">LOADING UNIVERSE</div>
    </div>

    <div id="canvas-container"></div>

    <button id="helpBtn" class="help-btn">
        <i class="fas fa-question"></i>
    </button>

    <div class="ui-layer flex flex-col justify-between p-6">
        <div class="flex justify-between items-start w-full">
            <div class="mt-2 ml-2 md:ml-36 pointer-events-auto"> <h1 class="text-white font-bold text-4xl tracking-widest drop-shadow-2xl" style="font-family: 'Impact', sans-serif; background: linear-gradient(to bottom, #ffffff, #c2e0ff); -webkit-background-clip: text; color: transparent;">THE COSMOS</h1>
                <p class="text-blue-300/90 text-[10px] mt-1 tracking-[0.4em] uppercase">Interactive Exhibition</p>
                
                <div class="score-board">
                    <i class="fas fa-star animate-pulse"></i>
                    <span id="scoreText">ENERGY: 0 / 15</span>
                </div>
            </div>

            <div id="instBox" class="instruction-box mt-2 mr-2 transition-all duration-500">
                <button id="closeInstBtn" class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center text-white/50 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="tab-container">
                    <div id="tabMobile" class="tab-btn active"><i class="fas fa-mobile-alt"></i> 手機版</div>
                    <div id="tabDesktop" class="tab-btn"><i class="fas fa-desktop"></i> 電腦版</div>
                </div>

                <h3 class="text-blue-200 text-xs font-bold tracking-widest mb-3 uppercase flex items-center">
                    <i class="fas fa-gamepad mr-2"></i> 操作說明 CONTROLS
                </h3>
                
                <ul id="instList" class="space-y-3 text-xs text-gray-200 font-light">
                    </ul>
            </div>
        </div>

        <div class="rotate-controls">
            <button id="rotLeftBtn" class="rotate-btn"><i class="fas fa-undo"></i></button>
            <button id="rotRightBtn" class="rotate-btn"><i class="fas fa-redo"></i></button>
        </div>

        <div id="infoModal" class="glass-panel absolute top-1/2 left-4 md:left-12 -translate-y-1/2 w-[90%] max-w-[360px] p-8 opacity-0 translate-x-[-40px] pointer-events-none transition-all duration-500">
            <button id="closeBtn" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-white/10 text-white/60 hover:bg-white/30 hover:text-white transition-all interactive">
                <i class="fas fa-times text-lg"></i>
            </button>
            <div class="absolute -top-4 -right-2 text-[100px] font-bold text-white/10 pointer-events-none select-none" id="mBgNum" style="font-family: Impact;">01</div>
            <h2 id="mName" class="text-4xl font-bold text-white mb-1 drop-shadow-md">PLANET</h2>
            <p id="mEn" class="text-cyan-300 text-xs font-bold tracking-[0.25em] mb-6 uppercase">System</p>
            <div class="h-[1px] w-full bg-gradient-to-r from-cyan-400/60 to-transparent mb-6"></div>
            <p id="mDesc" class="text-gray-100 text-sm leading-7 mb-8 font-light text-justify tracking-wide">Description...</p>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-800/30 rounded-xl p-3 border border-blue-400/30 backdrop-blur-sm">
                    <div class="text-[10px] text-blue-200/80 mb-1 uppercase tracking-wider">Type</div>
                    <div id="mTag1" class="text-sm text-white font-medium">Data</div>
                </div>
                <div class="bg-purple-800/30 rounded-xl p-3 border border-purple-400/30 backdrop-blur-sm">
                    <div class="text-[10px] text-purple-200/80 mb-1 uppercase tracking-wider">Distance</div>
                    <div id="mTag2" class="text-sm text-white font-medium">Data</div>
                </div>
            </div>
        </div>

        <div class="w-full interactive pb-8">
            <div class="flex justify-center items-center gap-6 overflow-x-auto px-10 py-4 no-scrollbar" id="menuContainer"></div>
        </div>
    </div>

    <script type="importmap">
        { 
            "imports": { 
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", 
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" 
            } 
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        // ==========================================
        // 1. 資料設定
        // ==========================================
        const planetsData = [
            { id: 'mercury', name: '水星', en: 'MERCURY', desc: '太陽系最小且最內側的行星。擁有巨大的鐵質核心，表面佈滿撞擊坑，因缺乏大氣層調節，晝夜溫差極大（430°C 至 -180°C），地貌神似月球。', tag1: '岩石行星', tag2: '0.39 AU', pos: 0, zOffset: 8, model: 'mercury.glb', modelScale: 10.0, icon: 'mercury_icon.jpg' },
            { id: 'venus', name: '金星', en: 'VENUS', desc: '夜空中最亮的星體。濃厚的大氣層主要由二氧化碳組成，引發失控的溫室效應，表面溫度高達 465°C。其自轉方向與大多數行星相反，且自轉比公轉還慢。', tag1: '岩石行星', tag2: '0.72 AU', pos: 25, zOffset: -12, model: 'venus.glb', modelScale: 12.0, icon: 'venus_icon.jpg' },
            { id: 'earth', name: '地球', en: 'EARTH', desc: '目前已知唯一有生命的星球。因為距離太陽的位置「剛剛好」，不像金星太熱、火星太冷，所以表面擁有液態水，讓萬物得以生存。', tag1: '生命搖籃', tag2: '1.00 AU', pos: 50, zOffset: 10, model: 'earth.glb', modelScale: 13.0, icon: 'earth_icon.jpg' },
            { id: 'mars', name: '火星', en: 'MARS', desc: '地表廣泛分佈氧化鐵而呈現橘紅色。擁有太陽系最高的「奧林帕斯山」與最長的「水手號峽谷」。雖大氣稀薄寒冷，但乾涸河床暗示著遠古時期曾有液態水。', tag1: '岩石行星', tag2: '1.52 AU', pos: 75, zOffset: -18, model: 'mars.glb', modelScale: 11.0, icon: 'mars_icon.jpg' },
            { id: 'jupiter', name: '木星', en: 'JUPITER', desc: '太陽系最大的氣態巨行星，質量是其他行星總和的 2.5 倍。主要由氫與氦組成，其標誌性的「大紅斑」是一個持續數百年、比地球還大的高壓風暴。', tag1: '氣態巨星', tag2: '5.20 AU', pos: 115, zOffset: 12, model: 'jupiter.glb', modelScale: 24.0, icon: 'jupiter_icon.jpg' },
            { id: 'saturn', name: '土星', en: 'SATURN', desc: '以壯麗且複雜的環系統聞名，主要由冰粒與岩石殘骸組成。它是密度最低的行星（小於水）。北極存在著神秘的六角形風暴結構，是大自然的幾何奇蹟。', tag1: '氣態巨星', tag2: '9.58 AU', pos: 155, zOffset: -22, model: 'saturn.glb', modelScale: 20.0, icon: 'saturn_icon.jpg' }
        ];

        let currentPlanetIndex = 2; 
        let score = 0; 
        const totalStars = 15; 

        // 2. 場景
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a1a); 
        scene.fog = new THREE.FogExp2(0x0a0a1a, 0.0015); 

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 4000); 
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2; 
        renderer.shadowMap.enabled = true; 
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 10; 
        controls.maxDistance = 500;

        // 星空背景
        function createBlueNebulaBackground() {
            const starGeo = new THREE.BufferGeometry();
            const starCount = 20000; 
            const starPos = new Float32Array(starCount * 3);
            for(let i=0; i<starCount*3; i++) starPos[i] = (Math.random() - 0.5) * 2000; 
            starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
            const starMat = new THREE.PointsMaterial({color: 0xffffff, size: 1.5, transparent: true, opacity: 1.0});
            scene.add(new THREE.Points(starGeo, starMat));

            const particleCount = 4000; 
            const particleGeo = new THREE.BufferGeometry();
            const particlePos = new Float32Array(particleCount * 3);
            const particleColors = new Float32Array(particleCount * 3);
            const color1 = new THREE.Color(0x2288ff); const color2 = new THREE.Color(0x8822ff); 
            for(let i=0; i<particleCount; i++) {
                const r = 500 + Math.random() * 500; const theta = Math.random() * Math.PI * 2; const phi = Math.acos(2 * Math.random() - 1);
                particlePos[i*3] = r * Math.sin(phi) * Math.cos(theta);
                particlePos[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                particlePos[i*3+2] = r * Math.cos(phi);
                const mixedColor = color1.clone().lerp(color2, Math.random());
                particleColors[i*3] = mixedColor.r; particleColors[i*3+1] = mixedColor.g; particleColors[i*3+2] = mixedColor.b;
            }
            particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePos, 3));
            particleGeo.setAttribute('color', new THREE.BufferAttribute(particleColors, 3));
            const canvas = document.createElement('canvas'); canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16,16,0,16,16,16);
            grad.addColorStop(0, 'rgba(255,255,255,1)'); grad.addColorStop(0.5, 'rgba(200,220,255,0.3)'); grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad; ctx.fillRect(0,0,32,32);
            const texture = new THREE.CanvasTexture(canvas);
            const particleMat = new THREE.PointsMaterial({ size: 10, map: texture, vertexColors: true, transparent: true, opacity: 0.8, depthWrite: false, blending: THREE.AdditiveBlending });
            scene.add(new THREE.Points(particleGeo, particleMat));
        }
        createBlueNebulaBackground();

        const sunLight = new THREE.DirectionalLight(0xffffff, 3.5); 
        sunLight.position.set(-100, 100, 100);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 4096; sunLight.shadow.mapSize.height = 4096; 
        sunLight.shadow.camera.near = 0.5; sunLight.shadow.camera.far = 1000;
        sunLight.shadow.camera.left = -200; sunLight.shadow.camera.right = 200; sunLight.shadow.camera.top = 200; sunLight.shadow.camera.bottom = -200;
        scene.add(sunLight);
        scene.add(new THREE.AmbientLight(0x404050, 3.0)); 
        scene.add(new THREE.DirectionalLight(0x4477ff, 1.5));

        // 3. Loader
        const gltfLoader = new GLTFLoader();
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
        dracoLoader.preload();
        gltfLoader.setDRACOLoader(dracoLoader);

        const planetMeshes = [];
        planetsData.forEach((data, index) => {
            gltfLoader.load(data.model, (gltf) => {
                const model = gltf.scene;
                model.position.set(data.pos, 0, data.zOffset);
                model.scale.set(data.modelScale, data.modelScale, data.modelScale);
                model.traverse(c => { if(c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });
                model.userData = { isPlanet: true, index: index };
                model.traverse(child => { if (child.isMesh) { child.userData = { isPlanet: true, index: index, parentGroup: model }; } });
                scene.add(model);
                planetMeshes[index] = model;
            }, undefined, (error) => { console.error(`無法載入星球模型: ${data.model}`, error); });
        });

        const planeGeometry = new THREE.PlaneGeometry(10000, 10000);
        const planeMaterial = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0 }); 
        const interactionPlane = new THREE.Mesh(planeGeometry, planeMaterial);
        interactionPlane.rotation.x = -Math.PI / 2;
        interactionPlane.position.y = -5.0; 
        scene.add(interactionPlane);

        // 星星系統
        const stars = [];
        const starGeometry = new THREE.OctahedronGeometry(2, 0); 
        const starMaterial = new THREE.MeshStandardMaterial({ color: 0xffd700, emissive: 0xffaa00, emissiveIntensity: 0.8, roughness: 0.2, metalness: 0.8 });

        for (let i = 0; i < totalStars; i++) {
            const star = new THREE.Mesh(starGeometry, starMaterial);
            const x = (Math.random() - 0.5) * 200 + 50; 
            const z = (Math.random() - 0.5) * 100;
            const y = (Math.random() * 20) - 5; 
            star.position.set(x, y, z);
            const light = new THREE.PointLight(0xffd700, 1, 10);
            star.add(light);
            scene.add(star);
            stars.push(star);
        }

        // 粒子
        const particles = [];
        const particleGeo = new THREE.SphereGeometry(0.3, 8, 8);
        const particleMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.8 });

        function createTrailParticle() {
            if (!astronaut) return;
            const p = new THREE.Mesh(particleGeo, particleMat.clone());
            const offset = new THREE.Vector3(0, 2, -1.5).applyQuaternion(astronaut.quaternion);
            p.position.copy(astronaut.position).add(offset);
            scene.add(p);
            particles.push({ mesh: p, life: 1.0 });
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.life -= 0.03; 
                p.mesh.scale.setScalar(p.life); 
                p.mesh.material.opacity = p.life;
                if (p.life <= 0) { scene.remove(p.mesh); particles.splice(i, 1); }
            }
        }

        let astronaut = null;
        let mixer = null;

        gltfLoader.load(
            'astronaut.glb', 
            (gltf) => {
                astronaut = gltf.scene;
                astronaut.scale.set(9.6, 9.6, 9.6); 
                const earthData = planetsData[2];
                astronaut.position.set(earthData.pos + 16, -2.0, earthData.zOffset + 2.0);
                astronaut.rotation.y = -Math.PI / 4; 
                astronaut.traverse(c => { if(c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });

                if (gltf.animations && gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(astronaut);
                    const action = mixer.clipAction(gltf.animations[0]);
                    action.play();
                } else if (gltf.scene.animations && gltf.scene.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(astronaut);
                    const action = mixer.clipAction(gltf.scene.animations[0]);
                    action.play();
                }
                scene.add(astronaut);
                document.getElementById('loader').style.display = 'none';
            },
            (xhr) => {},
            (error) => {
                console.error(error);
                alert("找不到 astronaut.glb！");
                const geo = new THREE.CapsuleGeometry(2, 4, 8, 16); 
                const mat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                astronaut = new THREE.Mesh(geo, mat);
                astronaut.position.set(50, -1.5, 10);
                scene.add(astronaut);
                document.getElementById('loader').style.display = 'none';
            }
        );

        // UI 切換邏輯
        const instList = document.getElementById('instList');
        const tabMobile = document.getElementById('tabMobile');
        const tabDesktop = document.getElementById('tabDesktop');

        const contentMobile = `
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-hand-pointer mr-1"></i> 拖曳太空人</span> <span>移動 + 噴射飛行</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-globe mr-1"></i> 點擊下方星球</span> <span>查看資訊與抵達</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-sync-alt mr-1"></i> 右下角按鈕</span> <span>旋轉太空人</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-star mr-1"></i> 點擊星星</span> <span>自動飛行蒐集</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-hand-paper mr-1"></i> 拖曳背景</span> <span>旋轉視角</span></li>
        `;

        const contentDesktop = `
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-mouse-pointer mr-1"></i> 左鍵拖曳</span> <span>移動太空人</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-mouse-pointer mr-1"></i> 右鍵 / 按鈕</span> <span>旋轉太空人</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-globe mr-1"></i> 點擊下方星球</span> <span>查看資訊與抵達</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-star mr-1"></i> 點擊星星</span> <span>自動飛行蒐集</span></li>
            <li class="flex items-center"><span class="key-badge"><i class="fas fa-hand-paper mr-1"></i> 拖曳背景</span> <span>旋轉視角</span></li>
        `;

        instList.innerHTML = contentMobile;

        tabMobile.addEventListener('click', () => {
            tabMobile.classList.add('active');
            tabDesktop.classList.remove('active');
            instList.innerHTML = contentMobile;
        });

        tabDesktop.addEventListener('click', () => {
            tabDesktop.classList.add('active');
            tabMobile.classList.remove('active');
            instList.innerHTML = contentDesktop;
        });

        // 互動控制
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        let isMovingAstronaut = false;   
        let isRotatingAstronaut = false; 
        let dragOffset = new THREE.Vector3();
        let previousMouseX = 0;
        let targetPosition = new THREE.Vector3();

        window.addEventListener('mousedown', onPointerDown);
        window.addEventListener('mousemove', onPointerMove);
        window.addEventListener('mouseup', onPointerUp);
        window.addEventListener('touchstart', onPointerDown, {passive: false});
        window.addEventListener('touchmove', onPointerMove, {passive: false});
        window.addEventListener('touchend', onPointerUp);

        // UI按鈕旋轉
        const rotLeftBtn = document.getElementById('rotLeftBtn');
        const rotRightBtn = document.getElementById('rotRightBtn');
        let rotateInterval;

        function startRotating(direction) {
            if(!astronaut) return;
            clearInterval(rotateInterval);
            rotateInterval = setInterval(() => { astronaut.rotation.y += direction * 0.05; }, 16);
        }
        function stopRotating() { clearInterval(rotateInterval); }

        rotLeftBtn.addEventListener('mousedown', () => startRotating(1));
        rotLeftBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRotating(1); });
        rotRightBtn.addEventListener('mousedown', () => startRotating(-1));
        rotRightBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRotating(-1); });
        window.addEventListener('mouseup', stopRotating);
        window.addEventListener('touchend', stopRotating);

        function onPointerDown(event) {
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            const isRightClick = (event.button === 2);

            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            if (astronaut) {
                const intersects = raycaster.intersectObject(astronaut, true);
                if (intersects.length > 0) {
                    controls.enabled = false; 
                    
                    if (isRightClick) {
                        isRotatingAstronaut = true;
                        previousMouseX = clientX;
                        document.body.style.cursor = 'alias'; 
                    } else {
                        isMovingAstronaut = true;
                        document.body.style.cursor = 'grabbing';
                        
                        targetPosition.copy(astronaut.position);

                        const currentZ = astronaut.position.z;
                        const dragPlane = new THREE.Plane(new THREE.Vector3(0, 0, 1), -currentZ);
                        const intersectPoint = new THREE.Vector3();
                        raycaster.ray.intersectPlane(dragPlane, intersectPoint);
                        
                        if (intersectPoint) { dragOffset.subVectors(astronaut.position, intersectPoint); }
                    }
                    return; 
                }
            }
        }

        function onPointerMove(event) {
            if (!isMovingAstronaut && !isRotatingAstronaut) return;
            if (event.preventDefault) event.preventDefault();

            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;

            if (isRotatingAstronaut && astronaut) {
                const deltaX = clientX - previousMouseX;
                astronaut.rotation.y += deltaX * 0.01;
                previousMouseX = clientX;
                return;
            }

            if (isMovingAstronaut && astronaut) {
                mouse.x = (clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);

                const currentPlanetZ = planetsData[currentPlanetIndex].zOffset;
                const targetZ = currentPlanetZ + 3.0; 
                
                const dragPlane = new THREE.Plane(new THREE.Vector3(0, 0, 1), -targetZ);
                const point = new THREE.Vector3();
                raycaster.ray.intersectPlane(dragPlane, point);

                if (point) {
                    const newX = point.x + dragOffset.x;
                    const newY = point.y + dragOffset.y;
                    targetPosition.set(newX, newY, targetZ);
                }
            }
        }

        function onPointerUp(event) {
            if (isMovingAstronaut || isRotatingAstronaut) {
                isMovingAstronaut = false;
                isRotatingAstronaut = false;
                controls.enabled = true;
                document.body.style.cursor = 'default';
            }
        }

        window.addEventListener('click', (event) => {
            if(isMovingAstronaut || isRotatingAstronaut) return;
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const starIntersects = raycaster.intersectObjects(stars);
            if (starIntersects.length > 0) {
                const targetStar = starIntersects[0].object;
                new TWEEN.Tween(astronaut.position)
                    .to({ x: targetStar.position.x, y: targetStar.position.y, z: targetStar.position.z + 1.0 }, 1500)
                    .easing(TWEEN.Easing.Cubic.Out)
                    .start();
                astronaut.lookAt(targetStar.position);
                return; 
            }

            const validPlanets = planetMeshes.filter(m => m !== undefined);
            const intersects = raycaster.intersectObjects(validPlanets, true);

            if (intersects.length > 0) {
                let target = intersects[0].object;
                while(target) {
                    if (target.userData && target.userData.isPlanet) {
                        flyToPlanet(target.userData.index);
                        document.querySelectorAll('.planet-btn').forEach(b => b.classList.remove('active'));
                        menuContainer.children[target.userData.index].classList.add('active');
                        break;
                    }
                    target = target.parent;
                }
            }
        });

        function flyToPlanet(index) {
            currentPlanetIndex = index;
            if (!planetMeshes[index]) return;
            
            const targetPlanet = planetMeshes[index];
            const data = planetsData[index];
            toggleModal(false);

            if (astronaut) {
                astronaut.position.set(data.pos + 16, -2.0, data.zOffset + 2.0);
                astronaut.rotation.y = -Math.PI / 4;
            }

            const dist = 4.0 * data.modelScale; 
            const offsetX = 0.8 * data.modelScale;
            const targetPos = { x: targetPlanet.position.x + offsetX, y: data.modelScale * 0.2, z: targetPlanet.position.z + dist };
            
            new TWEEN.Tween(camera.position).to(targetPos, 2500).easing(TWEEN.Easing.Cubic.InOut)
                .onUpdate(() => controls.target.set(targetPlanet.position.x, 0, targetPlanet.position.z))
                .onComplete(() => { updateModalContent(index); toggleModal(true); controls.minDistance = data.modelScale * 1.5; })
                .start();

            new TWEEN.Tween(controls.target).to({ x: targetPlanet.position.x, y: 0, z: targetPlanet.position.z }, 2500)
                .easing(TWEEN.Easing.Cubic.InOut).start();
        }

        const modal = document.getElementById('infoModal');
        const menuContainer = document.getElementById('menuContainer');
        const closeBtn = document.getElementById('closeBtn');
        const instBox = document.getElementById('instBox');
        const closeInstBtn = document.getElementById('closeInstBtn');
        const helpBtn = document.getElementById('helpBtn');
        const scoreText = document.getElementById('scoreText');

        closeInstBtn.addEventListener('click', () => {
            instBox.style.opacity = '0';
            instBox.style.pointerEvents = 'none';
            setTimeout(() => { helpBtn.classList.add('visible'); }, 300);
        });

        helpBtn.addEventListener('click', () => {
            instBox.style.opacity = '1';
            instBox.style.pointerEvents = 'auto'; 
            helpBtn.classList.remove('visible');
        });

        function updateModalContent(index) {
            const data = planetsData[index];
            document.getElementById('mBgNum').innerText = `0${index + 1}`;
            document.getElementById('mName').innerText = data.name;
            document.getElementById('mEn').innerText = data.en;
            document.getElementById('mDesc').innerText = data.desc;
            document.getElementById('mTag1').innerText = data.tag1;
            document.getElementById('mTag2').innerText = data.tag2;
        }

        function toggleModal(show) {
            if(show) {
                modal.classList.remove('opacity-0', 'translate-x-[-40px]', 'pointer-events-none');
                modal.classList.add('opacity-100', 'translate-x-0', 'pointer-events-auto');
            } else {
                modal.classList.add('opacity-0', 'translate-x-[-40px]', 'pointer-events-none');
                modal.classList.remove('opacity-100', 'translate-x-0', 'pointer-events-auto');
            }
        }

        closeBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleModal(false); });

        planetsData.forEach((p, i) => {
            const btn = document.createElement('div');
            btn.className = 'planet-btn';
            btn.style.backgroundImage = `url(${p.icon})`;
            btn.onclick = () => {
                document.querySelectorAll('.planet-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                flyToPlanet(i);
            };
            menuContainer.appendChild(btn);
        });

        const startIndex = 2; 
        camera.position.set(0, 40, 150); 
        setTimeout(() => {
            menuContainer.children[startIndex].click();
        }, 2000);

        const clock = new THREE.Clock();

        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);
            controls.update();
            planetMeshes.forEach(m => { if(m) m.rotation.y += 0.001; }); 
            if (mixer) mixer.update(clock.getDelta());

            // 粒子特效修復：在主循環中持續生成
            if (isMovingAstronaut && astronaut) {
                createTrailParticle();
                // Lerp 平滑移動
                astronaut.position.lerp(targetPosition, 0.1);
            }
            updateParticles();
            
            if(astronaut) {
                for (let i = stars.length - 1; i >= 0; i--) {
                    const star = stars[i];
                    star.rotation.y += 0.02;
                    star.rotation.x += 0.01;
                    
                    if (astronaut.position.distanceTo(star.position) < 8.0) { 
                        scene.remove(star);
                        stars.splice(i, 1);
                        score++;
                        scoreText.innerText = `ENERGY: ${score} / ${totalStars}`;
                    }
                }
            }

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
